# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions
# More info on Python, GitHub Actions, and Azure App Service: https://aka.ms/python-webapps-actions

name: Build and deploy Python app to Azure Web App - cimbxmicrosoft

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read #This is required for actions/checkout

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.0'

      - name: Build React frontend
        run: |
          cd frontend
          npm install
          npm run build
          cd ..

      - name: Set up Python version
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # üõ†Ô∏è Local Build Section (Optional)
      # The following section in your workflow is designed to catch build issues early on the client side, before deployment. This can be helpful for debugging and validation. However, if this step significantly increases deployment time and early detection is not critical for your workflow, you may remove this section to streamline the deployment process.
      - name: Create clean deployment package
        run: |
          mkdir deploy
          # Copy only essential files
          cp app.py requirements.txt runtime.txt deploy/
          # Copy built frontend (static files only)
          cp -r frontend/build deploy/frontend/
          # Copy uploads folder structure
          mkdir -p deploy/uploads
          # Show what we're deploying
          echo "Files to deploy:"
          find deploy -type f | wc -l
          du -sh deploy
          
      - name: Upload artifact for deployment
        uses: actions/upload-artifact@v4
        with:
          name: python-app
          path: deploy
      

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: python-app
          path: .

      - name: 'Deploy to Azure Web App'
        uses: azure/webapps-deploy@v3
        id: deploy-to-webapp
        with:
          app-name: 'cimbxmicrosoft'
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE }}
          package: .
          